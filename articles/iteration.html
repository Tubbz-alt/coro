<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Iteration in R • flowery</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Iteration in R">
<meta property="og:description" content="flowery">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flowery</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/iteration.html">Iteration in R</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="iteration_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Iteration in R</h1>
                        <h4 class="author">Lionel Henry</h4>
            
            <h4 class="date">2020-09-30</h4>
      
      
      <div class="hidden name"><code>iteration.Rmd</code></div>

    </div>

    
    
<div id="vector-operations-versus-chunked-data-flow" class="section level2">
<h2 class="hasAnchor">
<a href="#vector-operations-versus-chunked-data-flow" class="anchor"></a>Vector operations versus chunked data flow</h2>
<p>Every piece of data is a vector in R. Lists and data frames are finite collections of atomic vectors and hold all of their data in memory. Accordingly, R programming is vector-oriented. Arithmetic operations like <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code> are vectorised and applying functions over vectors (e.g. with <code><a href="https://rdrr.io/r/base/lapply.html">base::lapply()</a></code> or <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map()</a></code> and variants) is a favourite of R programmers.</p>
<p>However the vector approach only works when all of the data fits in memory. If it doesn’t fit, the data needs to be processed chunk by chunk. This is a task that is not well structured in R as of now. The purpose of flowery iterators is to provide the tools and idioms needed for structuring the generation and transformation of streams of chunked data.</p>
<p>The flowery package provides three complementary features:</p>
<ul>
<li><p><strong>Iterators</strong>: An iterator is a reference to the current data chunk that has two basic operations: advancing to the next chunk with <code>advance()</code> and dereferencing the current chunk with <code>deref()</code>. Advancing causes the actual generation of the next data chunk. You can use regular functions to create an iterator but it is often easier to use generators.</p></li>
<li><p><strong>Generators</strong>: Generators are the preferred way of creating iterators in flowery. They are special functions that can <em>pause</em> themselves. This feature is particularly handy for creating chunks of data iteratively.</p></li>
<li><p><strong>Transformation steps</strong>: Also called <a href="https://clojure.org/reference/transducers">transducers</a>, transformation steps make it easy to adapt iterators by mapping a function over incoming chunks or discarding unwanted elements. While understanding how transformation steps work under the hood is a bit involved, using them on iterators is very easy.</p></li>
</ul>
<p>This vignette explores how flowery envisions chunked iteration in R. It describes what it takes to generate data chunkwise, how the iterator wrappers structure the process of iterating over chunks, and finally how generators provide syntax that makes the process easy.</p>
</div>
<div id="iteration" class="section level2">
<h2 class="hasAnchor">
<a href="#iteration" class="anchor"></a>Iteration</h2>
<p>Iteration is a stateful thing. It is about advancing from one state to the next. Consider that simple loop:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="va">greet</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"hey"</span>, <span class="va">x</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">letters</span><span class="op">)</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">letters</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">greet</span><span class="op">(</span><span class="va">letters</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">x</span></pre></div>
<pre><code>##  [1] "hey a" "hey b" "hey c" "hey d" "hey e" "hey f" "hey g" "hey h" "hey i"
## [10] "hey j" "hey k" "hey l" "hey m" "hey n" "hey o" "hey p" "hey q" "hey r"
## [19] "hey s" "hey t" "hey u" "hey v" "hey w" "hey x" "hey y" "hey z"</code></pre>
<p>At each step the state changes. In this example the state is pretty simple, it is the index variable <code>i</code>. This changing state lets us <em>generate</em> different pieces of data. In this case <code>letters[[i]]</code> generates simple strings containing the letters of the alphabet. In a more involved case, we might pull out heavy data frames from a database.</p>
<p>What if we wanted to reuse that piece of code in a function with the objective of returning the data one piece at a time? Simply wrapping our loop only works when we want to return the whole vector:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">letters</span><span class="op">)</span><span class="op">)</span>

  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">letters</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">greet</span><span class="op">(</span><span class="va">letters</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">x</span>
<span class="op">}</span>
<span class="fu">iter</span><span class="op">(</span><span class="va">letters</span><span class="op">)</span></pre></div>
<pre><code>##  [1] "hey a" "hey b" "hey c" "hey d" "hey e" "hey f" "hey g" "hey h" "hey i"
## [10] "hey j" "hey k" "hey l" "hey m" "hey n" "hey o" "hey p" "hey q" "hey r"
## [19] "hey s" "hey t" "hey u" "hey v" "hey w" "hey x" "hey y" "hey z"</code></pre>
<p>Instead we need to emulate the loop manually. This means that we need a placeholder for the state! One way to achieve this is with function factories. See the relevant <a href="http://adv-r.had.co.nz/Functional-programming.html">Advanced R chapter</a> if you are not familiar with factories. Basically, a factory is a function that returns another function. Any data that you create there can be accessed by the new function. That’s a great way of keeping state between invocation:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">make_iter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Create placeholder for iteration state</span>
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">0</span>

  <span class="co"># Create and return the new iterator function</span>
  <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># Use the `&lt;&lt;-` operator to update non-local variables</span>
    <span class="va">i</span> <span class="op">&lt;&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span>
    <span class="fu">greet</span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu">make_iter</span><span class="op">(</span><span class="va">letters</span><span class="op">)</span></pre></div>
<p>Now let’s call our new iterator function:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu">iter</span><span class="op">(</span><span class="op">)</span>; <span class="fu">iter</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## [1] "hey a"</code></pre>
<pre><code>## [1] "hey b"</code></pre>
<p>To sum up, creating an iterator with a function factory involves two phases:</p>
<ul>
<li><p>Creating a persistent state in the environment of the returned iterator.</p></li>
<li><p>Updating this state from the iterator function with the <code><a href="https://rdrr.io/r/base/assignOps.html">&lt;&lt;-</a></code> operator.</p></li>
</ul>
<p>We’ll see later that generators make it very easy to manage the iteration state. But first let’s see what is missing from the iterator that we have created in order to use it effectively.</p>
</div>
<div id="iterator-operations" class="section level2">
<h2 class="hasAnchor">
<a href="#iterator-operations" class="anchor"></a>Iterator operations</h2>
<p>We have created a function that generates chunks of data on demand. We need to apply three operations to work with this iterator effectively:</p>
<ul>
<li>Advance to a new chunk.</li>
<li>Get the current chunk.</li>
<li>Check if the iterator is done.</li>
</ul>
<p>The first two operations are accomplished in a single step simply by calling the iterator function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu">make_iter</span><span class="op">(</span><span class="st">"foo"</span><span class="op">)</span>

<span class="co"># We advance the iterator and obtain the next value in one call:</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">iter</span><span class="op">(</span><span class="op">)</span>
<span class="va">x</span></pre></div>
<pre><code>## [1] "hey foo"</code></pre>
<p>However how can we check that we are done iterating? The iterator that we created had only one element to iterate over. If we call it again we get an out-of-bounds error:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu">iter</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## Error in x[[i]]: subscript out of bounds</code></pre>
<p>We need some kind of convention to signal termination of an iterator. In Python you would do this by throwing a special kind of exception. That requires wrapping iterators with <code><a href="https://rdrr.io/r/base/conditions.html">tryCatch()</a></code> each time they are advanced. For flowery we decided to signal termination with a sentinel value instead. The <code>NULL</code> value is a natural candidate. It is especially practical for iteration because many control flow operators return <code>NULL</code>. Let’s modify our iterator factory so that it returns <code>NULL</code> when it is done:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="va">make_iter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">0</span>
  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>  <span class="co"># We'll need to check the length of the vector</span>

  <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">i</span> <span class="op">&lt;&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span>

    <span class="co"># Return NULL if we are out of bounds</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">&lt;=</span> <span class="va">n</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu">greet</span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="cn">NULL</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu">make_iter</span><span class="op">(</span><span class="st">"foo"</span><span class="op">)</span>
<span class="fu">iter</span><span class="op">(</span><span class="op">)</span>; <span class="fu">iter</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## [1] "hey foo"</code></pre>
<pre><code>## NULL</code></pre>
<p>Not bad. Now how can we use this sentinel value to stop iterating at the right time? One way to do it would be to assign the next value in a temporary object and check that this value is not the sentinel. We can do both at the same time in a loop condition:</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu">make_iter</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"foo"</span>, <span class="st">"bar"</span><span class="op">)</span><span class="op">)</span>

<span class="kw">while</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">elt</span> <span class="op">&lt;-</span> <span class="fu">iter</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">elt</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<pre><code>## [1] "hey foo"
## [1] "hey bar"</code></pre>
<p>This is a bit hard to read though. For this reason flowery provides an iterator constructor that provides structured operations.</p>
</div>
<div id="flowery-iterators" class="section level2">
<h2 class="hasAnchor">
<a href="#flowery-iterators" class="anchor"></a>Flowery iterators</h2>
<p>In flowery, iteration is defined with a simple protocol:</p>
<ul>
<li><p>An iterator is a function.</p></li>
<li><p>An iterators is advanced by invoking it. It then returns the next value.</p></li>
<li><p>An iterator is exhausted as soon as it returns <code>NULL</code>.</p></li>
</ul>
<p>The iterator factory we have created already meets these specifications. That means we can use it in all flowery iteration contexts. For example we can use <code><a href="../reference/take.html">drain()</a></code> and its variants to repeatedly call the iterator until it’s exhausted and collect the values into a list or vector. <code><a href="../reference/take.html">drain()</a></code> creates a list:</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu">make_iter</span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="../reference/take.html">drain</a></span><span class="op">(</span><span class="va">iter</span><span class="op">)</span></pre></div>
<pre><code>## [[1]]
## [1] "hey a"
## 
## [[2]]
## [1] "hey b"
## 
## [[3]]
## [1] "hey c"</code></pre>
<p>While the other typed variants create atomic vectors:</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu">make_iter</span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="../reference/take.html">drain_chr</a></span><span class="op">(</span><span class="va">iter</span><span class="op">)</span></pre></div>
<pre><code>## [1] "hey a" "hey b" "hey c"</code></pre>
<p>It is perfectly possible for an iterator to never terminate. In this case you might want to take only a specific number of elements:</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu">make_iter</span><span class="op">(</span><span class="va">letters</span><span class="op">)</span>
<span class="fu"><a href="../reference/take.html">take_chr</a></span><span class="op">(</span><span class="va">iter</span>, <span class="fl">5</span><span class="op">)</span></pre></div>
<pre><code>## [1] "hey a" "hey b" "hey c" "hey d" "hey e"</code></pre>
</div>
<div id="generators" class="section level2">
<h2 class="hasAnchor">
<a href="#generators" class="anchor"></a>Generators</h2>
<p>The purpose of generators is to maintain state. This is why they are ideally suited for generation of data during iteration. The iterators that we created manually in the previous section can easily be turned into a generator. First create a generator constructor:</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">make_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generator.html">generator</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">names</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">names</span><span class="op">)</span> <span class="fu"><a href="../reference/yield.html">yield</a></span><span class="op">(</span><span class="fu">greet</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>Then use it to create an iterator function:</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu">make_gen</span><span class="op">(</span><span class="va">letters</span><span class="op">)</span></pre></div>
<p>The generator can be used just like any iterator:</p>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="fu">iter</span><span class="op">(</span><span class="op">)</span>; <span class="fu">iter</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## [1] "hey a"</code></pre>
<pre><code>## [1] "hey b"</code></pre>
<p>There are two things going on:</p>
<ul>
<li><p><code><a href="../reference/generator.html">generator()</a></code> returns an iterator function.</p></li>
<li><p><code><a href="../reference/yield.html">yield()</a></code> pauses the iterator function. When it is reentered, execution resumes from there. In this case the <code>for</code> loop inside our generator continues iterating as if the generator never exited.</p></li>
</ul>
<p>When a generator has yielded, it can be called or advanced to the next value and its execution will resume right at the yielding point. The ability to pause and resume considerably simplifies the task of generating data chunk by chunk because the state of the iterator is kept between iteration steps.</p>
<p>Note that generators (and iterators in general) are one-shot. Once iteration is done, reentering the generator issues an error. Let’s drain the remaining elements from the iterator:</p>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="fu"><a href="../reference/take.html">drain_chr</a></span><span class="op">(</span><span class="va">iter</span><span class="op">)</span></pre></div>
<pre><code>##  [1] "hey c" "hey d" "hey e" "hey f" "hey g" "hey h" "hey i" "hey j" "hey k"
## [10] "hey l" "hey m" "hey n" "hey o" "hey p" "hey q" "hey r" "hey s" "hey t"
## [19] "hey u" "hey v" "hey w" "hey x" "hey y" "hey z"</code></pre>
<p>From that point on, reentering the iterator is an error:</p>
<div class="sourceCode" id="cb31"><pre class="downlit">
<span class="fu">iter</span><span class="op">(</span><span class="op">)</span></pre></div>
<p>This generator factory can be reused as many times as needed to create fresh generators:</p>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu">make_gen</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"baz"</span>, <span class="st">"barbaz"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/take.html">drain</a></span><span class="op">(</span><span class="va">iter</span><span class="op">)</span></pre></div>
<pre><code>## [[1]]
## [1] "hey baz"
## 
## [[2]]
## [1] "hey barbaz"</code></pre>
<p>Note finally that generators don’t have to yield, they can also return. Once it has returned the generator is done:</p>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="va">my_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generator.html">generator</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>

  <span class="kw">for</span> <span class="op">(</span><span class="va">elt</span> <span class="kw">in</span> <span class="va">x</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">elt</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="../reference/yield.html">yield</a></span><span class="op">(</span><span class="va">elt</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span><span class="op">)</span>

<span class="fu"><a href="../reference/take.html">drain_dbl</a></span><span class="op">(</span><span class="fu">my_gen</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1]   1   2   3   4 100</code></pre>
</div>
<div id="transforming-iterators" class="section level2">
<h2 class="hasAnchor">
<a href="#transforming-iterators" class="anchor"></a>Transforming iterators</h2>
<p>As we have seen iterator and generators are useful for generating data chunk by chunk in a structured way. The flowery package also offers several ways of transforming the stream of data chunks.</p>
<div id="chaining-generator-expressions" class="section level3">
<h3 class="hasAnchor">
<a href="#chaining-generator-expressions" class="anchor"></a>Chaining generator expressions</h3>
<p>Inside a generator you can supply iterators to <code>for</code> loops. This makes it easy to chain generators:</p>
<div class="sourceCode" id="cb36"><pre class="downlit">
<span class="va">integer_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generator.html">generator</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">vec</span><span class="op">)</span> <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">vec</span><span class="op">)</span> <span class="fu"><a href="../reference/yield.html">yield</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="va">square_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generator.html">generator</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">iter</span><span class="op">)</span> <span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">iter</span><span class="op">)</span> <span class="fu"><a href="../reference/yield.html">yield</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>The <code><a href="../reference/generator.html">gen()</a></code> alias is a shortcut for creating generator functions on the spot without going through a constructor:</p>
<div class="sourceCode" id="cb37"><pre class="downlit">
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
<span class="va">square_iter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generator.html">gen</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">data</span><span class="op">)</span> <span class="fu"><a href="../reference/yield.html">yield</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">final_iter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generator.html">gen</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">square_iter</span><span class="op">)</span> <span class="fu"><a href="../reference/yield.html">yield</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>Draining the final iterator iterates over all iterators in turn. What happens to intermediate values? They are discarded from memory as iteration advances. Only the final summary value is kept in the final output vector:</p>
<div class="sourceCode" id="cb38"><pre class="downlit">
<span class="fu"><a href="../reference/take.html">drain_dbl</a></span><span class="op">(</span><span class="va">final_iter</span><span class="op">)</span></pre></div>
<pre><code>##  [1]   100   400   900  1600  2500  3600  4900  6400  8100 10000</code></pre>
</div>
<div id="transformation-step" class="section level3">
<h3 class="hasAnchor">
<a href="#transformation-step" class="anchor"></a>Transformation step</h3>
<p>Transformation steps bring the familiar <code>map</code>, <code>keep</code> or <code>discard</code> idioms that you know from purrr to iterators. You can map a function over iterated chunks with <code><a href="../reference/steps.html">iter_map()</a></code> and discard or keep unwanted elements with <code><a href="../reference/steps.html">iter_discard()</a></code> and <code><a href="../reference/steps.html">iter_keep()</a></code>. You apply these steps to iterators with <code><a href="../reference/iter_adapt.html">iter_adapt()</a></code>, which takes an iterator and steps as inputs and returns another iterator.</p>
<p>Let’s apply steps so that odd numbers are discarded and all values that pass through the filter are squared by mapping the <code><a href="https://rdrr.io/r/base/Arithmetic.html">^</a></code> operator. Note that transformation steps support purrr’s <code><a href="https://rdrr.io/r/base/tilde.html">~</a></code> notation for lambda functions:</p>
<div class="sourceCode" id="cb40"><pre class="downlit">
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generator.html">gen</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="../reference/yield.html">yield</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>

<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/iter_adapt.html">iter_adapt</a></span><span class="op">(</span><span class="va">iter</span>,
  <span class="fu"><a href="../reference/steps.html">iter_discard</a></span><span class="op">(</span><span class="op">~</span> <span class="va">.</span> <span class="op">%%</span> <span class="fl">2</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/steps.html">iter_map</a></span><span class="op">(</span><span class="va">`^`</span>, <span class="fl">2</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="../reference/take.html">drain_dbl</a></span><span class="op">(</span><span class="va">iter</span><span class="op">)</span></pre></div>
<pre><code>## [1]   4  16  36  64 100</code></pre>
</div>
<div id="iteration-with-for-loops" class="section level3">
<h3 class="hasAnchor">
<a href="#iteration-with-for-loops" class="anchor"></a>Iteration with for loops</h3>
<p>Finally, flowery provides <code><a href="../reference/iterate.html">iterate()</a></code>. It takes a <code>for</code> loop expression and instruments it so it understands flowery iterators.</p>
<div class="sourceCode" id="cb42"><pre class="downlit">
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generator.html">gen</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="fu"><a href="../reference/yield.html">yield</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="../reference/iterate.html">iterate</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">iter</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"iteration:"</span>, <span class="va">x</span>, <span class="st">"\n"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<pre><code>## iteration: 1 
## iteration: 4 
## iteration: 9 
## iteration: 16 
## iteration: 25 
## iteration: 36 
## iteration: 49 
## iteration: 64 
## iteration: 81 
## iteration: 100</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lionel Henry.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
